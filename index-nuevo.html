<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Votación de Imágenes</title>
    <link href="https://fonts.googleapis.com/css2?family=Dosis:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Dosis', sans-serif;
            background: linear-gradient(135deg, #dc770e 0%, #fbd21d 100%);
            min-height: 100vh;
            color: #000;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            touch-action: manipulation;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 10px;
        }

        .header {
            text-align: center;
            color: #000;
            margin-bottom: 30px;
            padding: 20px 10px;
        }

        .header h1 {
            font-size: clamp(2em, 6vw, 3em);
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(255,255,255,0.3);
            font-weight: 700;
        }

        .voting-container {
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            padding: 20px;
            margin: 0 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
        }

        .voting-pair {
            background: white;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            text-align: center;
        }

        .voting-pair h3 {
            margin-bottom: 15px;
            color: #000;
            font-size: clamp(20px, 5vw, 28px);
            font-weight: 600;
        }

        .voting-pair p {
            font-size: clamp(14px, 3vw, 16px);
            margin-bottom: 20px;
            color: #666;
        }

        .images-comparison {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 25px;
            margin-bottom: 25px;
        }

        .vote-option {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            cursor: pointer;
            border: 3px solid transparent;
            width: 100%;
            max-width: 350px;
        }

        .vote-option:hover, .vote-option:active {
            transform: translateY(-3px);
            border-color: #dc770e;
            box-shadow: 0 8px 25px rgba(220, 119, 14, 0.25);
        }

        .vote-option img {
            width: 100%;
            max-width: 280px;
            height: 280px;
            object-fit: cover;
            border-radius: 12px;
            margin-bottom: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .vote-option h4 {
            margin-bottom: 15px;
            font-weight: 600;
            color: #dc770e;
            font-size: clamp(18px, 4vw, 24px);
        }

        .vote-btn {
            background: #dc770e;
            color: white;
            border: none;
            padding: 18px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: clamp(16px, 4vw, 20px);
            font-weight: 600;
            font-family: 'Dosis', sans-serif;
            transition: all 0.3s ease;
            width: 100%;
            min-height: 60px;
            touch-action: manipulation;
        }

        .vote-btn:hover, .vote-btn:active {
            background: #b8630c;
            transform: scale(1.02);
        }

        .vote-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .navigation-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-top: 25px;
            flex-wrap: wrap;
            padding: 0 10px;
        }

        .nav-control {
            background: #fbd21d;
            color: #000;
            border: none;
            padding: 15px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: clamp(16px, 4vw, 18px);
            font-weight: 600;
            font-family: 'Dosis', sans-serif;
            transition: all 0.3s ease;
            min-height: 50px;
            min-width: 120px;
            touch-action: manipulation;
        }

        .nav-control:hover, .nav-control:active {
            background: #e6bd0a;
            transform: translateY(-2px);
        }

        .nav-control:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        #pairCounter {
            font-weight: 600;
            font-size: clamp(18px, 5vw, 22px);
            color: #000;
            text-align: center;
            min-width: 140px;
            padding: 10px;
            background: rgba(255,255,255,0.8);
            border-radius: 15px;
        }

        .status-message {
            text-align: center;
            padding: 20px;
            margin: 15px 10px;
            border-radius: 15px;
            font-weight: 600;
            font-family: 'Dosis', sans-serif;
            font-size: clamp(16px, 4vw, 18px);
        }

        .success {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }

        .warning {
            background: #fff3cd;
            color: #856404;
            border: 2px solid #fbd21d;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }

        .loading {
            text-align: center;
            padding: 30px;
            color: #666;
            font-size: clamp(18px, 5vw, 22px);
        }

        @media (min-width: 769px) and (max-width: 1024px) {
            .images-comparison {
                flex-direction: row;
                justify-content: center;
                flex-wrap: wrap;
            }

            .vote-option {
                max-width: 300px;
            }
        }

        @media (min-width: 1025px) {
            .images-comparison {
                flex-direction: row;
                justify-content: center;
            }

            .vote-option {
                max-width: 320px;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 5px;
            }

            .header {
                padding: 15px 5px;
            }

            .voting-container {
                margin: 0 5px;
                padding: 15px;
            }

            .voting-pair {
                padding: 15px;
            }

            .vote-option img {
                height: 220px;
            }

            .navigation-controls {
                gap: 10px;
            }

            .nav-control {
                padding: 12px 20px;
                min-width: 100px;
            }

            #pairCounter {
                width: 100%;
                order: -1;
                margin-bottom: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>¡Vota por tu imagen favorita!</h1>
        </div>

        <div class="voting-container">
            <div id="votingContent">
                <div class="loading">Cargando imágenes disponibles...</div>
            </div>
            
            <div class="navigation-controls">
                <button class="nav-control" id="prevBtn" onclick="previousPair()">⬅️ Anterior</button>
                <div id="pairCounter">Cargando...</div>
                <button class="nav-control" id="nextBtn" onclick="nextPair()">Siguiente ➡️</button>
            </div>
        </div>
    </div>

    <script>
        // Configuración de Supabase
        const SUPABASE_URL = 'https://dfxzwodoshldrucupqqa.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRmeHp3b2Rvc2hsZHJ1Y3VwcXFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk0MjYwNzUsImV4cCI6MjA3NTAwMjA3NX0.wMgKkTX50pwPCB6N7iNQYsadF4pQJLREb7xGzwYBqkI';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let persons = [];
        let currentPairIndex = 0;
        let userIP = null;
        let votedPairs = new Set();

        // Generar ID único para el usuario
        function generateUserIP() {
            if (!userIP) {
                userIP = 'user_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
                localStorage.setItem('userIP', userIP);
            }
            return userIP;
        }

        // Inicialización
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Iniciando aplicación de votación...');
            userIP = localStorage.getItem('userIP') || generateUserIP();
            console.log('User IP:', userIP);
            loadData();
            setupRealtimeSubscriptions();
            loadVotedPairs();
        });

        // Configurar suscripciones en tiempo real
        function setupRealtimeSubscriptions() {
            // Suscripción a cambios en persons (nuevas imágenes, actualizaciones)
            supabase
                .channel('voting_persons')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'persons' }, () => {
                    console.log('Cambio detectado en persons - Recargando competencias...');
                    loadData();
                })
                .subscribe();

            // Suscripción a cambios en votes (nuevos votos)
            supabase
                .channel('voting_votes')
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'votes' }, (payload) => {
                    console.log('Nuevo voto detectado:', payload);
                    // Nota: Los contadores se actualizan en el admin, aquí solo registramos el evento
                })
                .subscribe();
                
            console.log('Suscripciones en tiempo real configuradas');
        }

        // Cargar datos
        async function loadData() {
            try {
                console.log('Cargando personas desde Supabase...');
                const { data, error } = await supabase
                    .from('persons')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                console.log('Datos recibidos:', data);

                // Filtrar solo personas con ambas imágenes
                persons = (data || []).filter(p => p.image1_url && p.image2_url);
                console.log('Personas con ambas imágenes:', persons.length);

                if (persons.length === 0) {
                    document.getElementById('votingContent').innerHTML = `
                        <div class="status-message warning">
                            No hay imágenes disponibles para votar.<br>
                            El administrador debe subir imágenes primero.
                        </div>
                    `;
                    return;
                }

                // Si ya estábamos viendo competencias, actualizar la vista
                if (currentPairIndex >= 0 && currentPairIndex < persons.length) {
                    displayVotingPair();
                    updatePairCounter();
                } else {
                    setupVoting();
                }
                
                console.log('Datos actualizados automáticamente en index.html');
            } catch (error) {
                console.error('Error cargando datos:', error);
                showMessage('Error conectando con la base de datos: ' + error.message, 'error');
            }
        }

        // Cargar pares ya votados
        function loadVotedPairs() {
            const stored = localStorage.getItem('votedPairs_' + userIP);
            if (stored) {
                votedPairs = new Set(JSON.parse(stored));
                console.log('Pares votados cargados:', Array.from(votedPairs));
            }
        }

        // Guardar par votado
        function saveVotedPair(personId) {
            votedPairs.add(personId);
            localStorage.setItem('votedPairs_' + userIP, JSON.stringify(Array.from(votedPairs)));
            console.log('Par guardado como votado:', personId);
        }

        // Configurar votación
        function setupVoting() {
            if (persons.length === 0) {
                document.getElementById('votingContent').innerHTML = `
                    <div class="status-message warning">
                        No hay imágenes disponibles para votar.<br>
                        Espera a que el administrador cargue imágenes.
                    </div>
                `;
                return;
            }

            currentPairIndex = 0;
            displayVotingPair();
            updatePairCounter();
        }

        // Mostrar par actual para votación
        function displayVotingPair() {
            if (currentPairIndex >= persons.length) {
                document.getElementById('votingContent').innerHTML = `
                    <div class="status-message success">
                        ¡Has revisado todos los pares de imágenes!<br>
                        Gracias por participar en la votación.
                    </div>
                `;
                return;
            }

            const person = persons[currentPairIndex];
            const hasVoted = votedPairs.has(person.id);

            // Obtener nombres, con fallback
            const name1 = person.full_name_img1 || 'Participante 1';
            const name2 = person.full_name_img2 || 'Participante 2';

            console.log('Mostrando competencia:', person.name, 'Ya votó:', hasVoted);

            document.getElementById('votingContent').innerHTML = `
                <div class="voting-pair">
                    <h3>¿Cuál imagen prefieres?</h3>
                    <p>Competencia: <strong>${person.name}</strong></p>
                    ${hasVoted ? '<div class="status-message success">✅ Ya has votado en esta competencia</div>' : ''}
                    <div class="images-comparison">
                        <div class="vote-option">
                            <img src="${person.image1_url}" alt="${name1}">
                            <h4>${name1}</h4>
                            <button class="vote-btn" onclick="vote('${person.id}', 1, '${name1.replace(/'/g, "\\'")}');" ${hasVoted ? 'disabled' : ''}>
                                ${hasVoted ? '✅ Ya votaste' : '👍 Votar por ' + name1}
                            </button>
                        </div>
                        <div class="vote-option">
                            <img src="${person.image2_url}" alt="${name2}">
                            <h4>${name2}</h4>
                            <button class="vote-btn" onclick="vote('${person.id}', 2, '${name2.replace(/'/g, "\\'")}');" ${hasVoted ? 'disabled' : ''}>
                                ${hasVoted ? '✅ Ya votaste' : '👍 Votar por ' + name2}
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Votar por una imagen
        async function vote(personId, imageNumber, personName) {
            console.log('Intentando votar:', { personId, imageNumber, personName });

            if (votedPairs.has(personId)) {
                showMessage('Ya has votado en esta competencia.', 'warning');
                return;
            }

            try {
                console.log('Insertando voto en Supabase...');
                const { data, error } = await supabase
                    .from('votes')
                    .insert([
                        { 
                            person_id: personId, 
                            image_number: imageNumber
                        }
                    ])
                    .select();

                if (error) {
                    console.error('Error de Supabase:', error);
                    throw error;
                }

                console.log('Voto insertado exitosamente:', data);

                saveVotedPair(personId);
                displayVotingPair();
                
                showMessage(`¡Voto registrado por ${personName}!`, 'success');
                
            } catch (error) {
                console.error('Error completo al votar:', error);
                showMessage('Error registrando voto: ' + error.message, 'error');
            }
        }

        // Navegación entre pares
        function previousPair() {
            if (currentPairIndex > 0) {
                currentPairIndex--;
                displayVotingPair();
                updatePairCounter();
            }
        }

        function nextPair() {
            if (currentPairIndex < persons.length - 1) {
                currentPairIndex++;
                displayVotingPair();
                updatePairCounter();
            }
        }

        // Actualizar contador de pares
        function updatePairCounter() {
            const counter = document.getElementById('pairCounter');
            counter.textContent = `${currentPairIndex + 1} de ${persons.length}`;
            
            document.getElementById('prevBtn').disabled = currentPairIndex === 0;
            document.getElementById('nextBtn').disabled = currentPairIndex === persons.length - 1;
        }

        // Mostrar mensajes de estado
        function showMessage(message, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `status-message ${type}`;
            messageDiv.innerHTML = message;
            
            messageDiv.style.position = 'fixed';
            messageDiv.style.top = '20px';
            messageDiv.style.left = '50%';
            messageDiv.style.transform = 'translateX(-50%)';
            messageDiv.style.zIndex = '1000';
            messageDiv.style.maxWidth = '90vw';
            
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 4000);
        }
    </script>
</body>
</html>
